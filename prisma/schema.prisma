generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String  @id @default(uuid())
  email             String? @unique
  phone             String  @unique
  passwordHash      String
  isActive          Boolean @default(true)
  applicantVerified Boolean @default(false)

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  failedLoginCount Int       @default(0)
  lockUntil        DateTime?
  tokenVersion     Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles     UserRole[]
  refreshTokens RefreshToken[]
  actionTokens  AccountActionToken[]
  auditLogs     AuditLog[]           @relation("AuditPerformedBy")

  applicantProfile     ApplicantProfile?
  employer             Employer?
  employerApprovalLogs EmployerApprovalLog[]
  cvAdminReviews       CvAdminReview[]

  visaAssignedAsCaseOfficer VisaApplication[]        @relation("VisaAssignedCaseOfficer")
  visaSubmittedByMe         VisaApplication[]        @relation("VisaSubmittedByAdmin")
  visaStatusHistories       VisaStatusHistory[]
  visaDocsUploadedByMe      VisaDocument[]           @relation("VisaDocUploadedBy")
  visaDocsVerifiedByMe      VisaDocument[]           @relation("VisaDocVerifiedBy")
  visaComplianceChecks      VisaComplianceCheck[]
  visaNotifications         VisaNotification[]
  localAgency               LocalAgency?
  localAgencyApprovalLogs   LocalAgencyApprovalLog[] @relation("LocalAgencyActionBy")
}


model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String
  jti       String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum AccountActionTokenType {
  ACCOUNT_SETUP
  PASSWORD_RESET
  EMAIL_VERIFY
}

model AccountActionToken {
  id        String                 @id @default(uuid())
  userId    String
  type      AccountActionTokenType
  tokenHash String                 @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime               @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  performedBy String?
  action      String
  entityType  String?
  entityId    String?
  ipAddress   String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  performer User? @relation("AuditPerformedBy", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([performedBy])
  @@index([createdAt])
  @@index([action])
}

enum LocalAgencyStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum LocalAgencyApprovalAction {
  APPROVED
  REJECTED
  SUSPENDED
  REACTIVATED
}

model LocalAgency {
  id            String            @id @default(uuid())
  name          String
  licenseNumber String            @unique
  contactPerson String?
  phone         String?
  email         String?
  status        LocalAgencyStatus @default(PENDING)

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  rejectionReason String?
  approvedBy      String?
  approvedAt      DateTime?
  suspendedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  approvalLogs LocalAgencyApprovalLog[]

  @@index([status])
  @@index([licenseNumber])
  @@index([phone])
  @@index([email])
}

model LocalAgencyApprovalLog {
  id         String                    @id @default(uuid())
  agencyId   String
  action     LocalAgencyApprovalAction
  reason     String?
  actionBy   String
  actionDate DateTime                  @default(now())

  agency LocalAgency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  admin  User        @relation("LocalAgencyActionBy", fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([actionDate])
}

enum ApplicantProfileStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

enum ApplicantDocumentType {
  PASSPORT
  PERSONAL_PHOTO
  COC_CERTIFICATE
  LABOR_ID
  OTHER
}

enum ApplicantRegistrationSource {
  SELF
  AGENCY
  MUB_STAFF
}

model ApplicantProfile {
  applicantId String  @id @default(uuid())
  userId      String? @unique

  firstName      String?
  lastName       String?
  gender         String?
  dateOfBirth    DateTime?
  nationality    String?
  passportNumber String?
  passportExpiry DateTime?
  laborId        String?
  region         String?

  phone         String
  email         String?
  address       String?
  maritalStatus String?

  visaNumber        String?
  applicationNumber String?
  barcodeValue      String?

  registrationSource ApplicantRegistrationSource @default(SELF)
  createdBy          String?

  profileStatus ApplicantProfileStatus @default(DRAFT)

  rejectionReason String?
  verifiedBy      String?
  verifiedAt      DateTime?
  submittedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  skills           ApplicantSkill[]
  qualifications   ApplicantQualification[]
  workExperiences  ApplicantWorkExperience[]
  documents        ApplicantDocument[]
  draftTokens      ApplicantDraftToken[]
  applicantCvs     ApplicantCv[]
  visaApplications VisaApplication[]

  @@unique([phone])
  @@index([email])
  @@index([passportNumber])
  @@index([profileStatus])
  @@index([laborId])
  @@index([registrationSource])
  @@index([createdBy])
}


model ApplicantDocument {
  id                 String                @id @default(uuid())
  applicantId        String
  documentType       ApplicantDocumentType
  fileUrl            String
  verificationStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([applicantId, documentType])
  @@index([applicantId])
  @@index([documentType])
}

model ApplicantDraftToken {
  id          String    @id @default(uuid())
  applicantId String
  tokenHash   String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
  @@index([expiresAt])
}

model ApplicantSkill {
  id                String  @id @default(uuid())
  applicantId       String
  skillName         String
  proficiencyLevel  String?
  yearsOfExperience Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([applicantId, skillName])
  @@index([applicantId])
}

model ApplicantQualification {
  id                String  @id @default(uuid())
  applicantId       String
  qualificationType String
  institution       String?
  country           String?
  yearCompleted     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

model ApplicantWorkExperience {
  id               String    @id @default(uuid())
  applicantId      String
  jobTitle         String
  employerName     String?
  country          String?
  startDate        DateTime?
  endDate          DateTime?
  responsibilities String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

enum EmployerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum EmployerCreatedBy {
  EMPLOYER
  ADMIN
}

enum EmployerApprovalAction {
  APPROVED
  REJECTED
}

enum JobStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum ContractType {
  FULL_TIME
  PART_TIME
  TEMPORARY
  CONTRACT
  OTHER
}

model Employer {
  id                 String  @id @default(uuid())
  organizationName   String
  country            String
  contactEmail       String
  contactPhone       String
  registrationNumber String  @unique
  address            String?

  ownerName      String
  ownerIdNumber  String
  licenseNumber  String    @unique
  licenseFileUrl String
  licenseExpiry  DateTime?

  status    EmployerStatus    @default(PENDING)
  createdBy EmployerCreatedBy
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  approvalLogs     EmployerApprovalLog[]
  jobs             JobPosting[]
  visaApplications VisaApplication[]

  @@unique([contactEmail])
  @@unique([contactPhone])
  @@index([status])
  @@index([country])
  @@index([licenseNumber])
  @@index([ownerIdNumber])
}

model EmployerApprovalLog {
  id         String                 @id @default(uuid())
  employerId String
  action     EmployerApprovalAction
  reason     String?
  actionBy   String
  actionDate DateTime               @default(now())

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)
  admin    User     @relation(fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([actionDate])
}

model JobPosting {
  id             String       @id @default(uuid())
  employerId     String
  jobTitle       String
  jobDescription String
  country        String
  city           String?
  salaryRange    String?
  contractType   ContractType
  status         JobStatus    @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employer         Employer          @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applicantCvs     ApplicantCv[]
  visaApplications VisaApplication[]

  @@index([employerId])
  @@index([status])
  @@index([country])
}

enum ApplicantCvStatus {
  draft
  submitted
  approved
  rejected
}

enum CvAdminReviewStatus {
  approved
  rejected
}

model CvTemplate {
  id           String   @id @default(uuid())
  name         String
  description  String?
  htmlTemplate String
  cssStyle     String?
  isActive     Boolean  @default(true)
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cvs ApplicantCv[]

  @@index([isActive])
  @@index([createdAt])
}

model ApplicantCv {
  id             String            @id @default(uuid())
  applicantId    String
  jobId          String?
  cvTemplateId   String
  status         ApplicantCvStatus @default(draft)
  currentVersion Int               @default(0)
  submittedAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  template  CvTemplate       @relation(fields: [cvTemplateId], references: [id], onDelete: Restrict)
  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)
  job       JobPosting?      @relation(fields: [jobId], references: [id], onDelete: SetNull)

  versions ApplicantCvVersion[]
  sections ApplicantCvSection[]
  reviews  CvAdminReview[]
  audits   CvAuditLog[]

  @@index([applicantId])
  @@index([jobId])
  @@index([status])
  @@index([createdAt])
}

model ApplicantCvVersion {
  id            String   @id @default(uuid())
  cvId          String
  versionNumber Int
  pdfUrl        String
  htmlSnapshot  String
  isFinal       Boolean  @default(false)
  createdAt     DateTime @default(now())

  cv ApplicantCv @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@unique([cvId, versionNumber])
  @@index([cvId])
  @@index([createdAt])
}

model ApplicantCvSection {
  id            String  @id @default(uuid())
  cvId          String
  sectionName   String
  isEnabled     Boolean @default(true)
  displayOrder  Int
  customContent Json?

  cv ApplicantCv @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@unique([cvId, sectionName])
  @@index([cvId])
  @@index([displayOrder])
}

model CvAdminReview {
  id         String              @id @default(uuid())
  cvId       String
  adminId    String
  status     CvAdminReviewStatus
  comments   String?
  reviewedAt DateTime            @default(now())

  cv    ApplicantCv @relation(fields: [cvId], references: [id], onDelete: Cascade)
  admin User        @relation(fields: [adminId], references: [id], onDelete: Restrict)

  @@index([cvId])
  @@index([reviewedAt])
}

model CvAuditLog {
  id          String   @id @default(uuid())
  cvId        String
  action      String
  performedBy String?
  meta        Json?
  performedAt DateTime @default(now())

  cv ApplicantCv @relation(fields: [cvId], references: [id], onDelete: Cascade)

  @@index([cvId])
  @@index([performedAt])
}

enum VisaApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ADDITIONAL_DOCUMENTS_REQUIRED
  EMBASSY_PROCESSING
  APPROVED
  REJECTED
  EXPIRED
  WITHDRAWN
}

enum VisaDocumentType {
  PASSPORT
  MEDICAL_CLEARANCE
  POLICE_CLEARANCE
  EMPLOYMENT_CONTRACT
  INVITATION_LETTER
  EMBASSY_FORMS
  OTHER
}

enum VisaDocumentVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VisaComplianceRequirementStatus {
  PENDING
  COMPLETED
  FAILED
}

enum VisaNotificationType {
  EXPIRY_ALERT
  STATUS_UPDATE
  DOCUMENT_REQUEST
  DECISION_RECORDED
}

model VisaApplication {
  id                   String                @id @default(uuid())
  applicantId          String
  employerId           String?
  jobId                String?
  visaType             String
  destinationCountry   String
  applicationReference String?
  status               VisaApplicationStatus @default(DRAFT)

  assignedCaseOfficerId String?
  submittedByAdminId    String?
  submissionDate        DateTime?
  decisionDate          DateTime?
  visaIssueDate         DateTime?
  visaExpiryDate        DateTime?

  remarks String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)
  employer  Employer?        @relation(fields: [employerId], references: [id], onDelete: SetNull)
  job       JobPosting?      @relation(fields: [jobId], references: [id], onDelete: SetNull)

  assignedCaseOfficer User? @relation("VisaAssignedCaseOfficer", fields: [assignedCaseOfficerId], references: [id], onDelete: SetNull)
  submittedByAdmin    User? @relation("VisaSubmittedByAdmin", fields: [submittedByAdminId], references: [id], onDelete: SetNull)

  documents     VisaDocument[]
  compliance    VisaComplianceCheck[]
  statusHistory VisaStatusHistory[]
  notifications VisaNotification[]

  @@index([applicantId])
  @@index([employerId])
  @@index([jobId])
  @@index([status])
  @@index([destinationCountry])
  @@index([assignedCaseOfficerId])
}

model VisaStatusHistory {
  id                String                 @id @default(uuid())
  visaApplicationId String
  previousStatus    VisaApplicationStatus?
  newStatus         VisaApplicationStatus
  changedByAdminId  String?
  changeReason      String?
  changedAt         DateTime               @default(now())

  visa  VisaApplication @relation(fields: [visaApplicationId], references: [id], onDelete: Cascade)
  admin User?           @relation(fields: [changedByAdminId], references: [id], onDelete: SetNull)

  @@index([visaApplicationId])
  @@index([changedAt])
  @@index([newStatus])
}

model VisaDocument {
  id                 String                         @id @default(uuid())
  visaApplicationId  String
  documentType       VisaDocumentType
  fileUrl            String
  fileHash           String?
  versionNumber      Int                            @default(1)
  isActive           Boolean                        @default(true)
  verificationStatus VisaDocumentVerificationStatus @default(PENDING)
  verificationReason String?
  verifiedByAdminId  String?
  verifiedAt         DateTime?

  uploadedByAdminId String?
  uploadedAt        DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visa       VisaApplication @relation(fields: [visaApplicationId], references: [id], onDelete: Cascade)
  verifiedBy User?           @relation("VisaDocVerifiedBy", fields: [verifiedByAdminId], references: [id], onDelete: SetNull)
  uploadedBy User?           @relation("VisaDocUploadedBy", fields: [uploadedByAdminId], references: [id], onDelete: SetNull)

  @@index([visaApplicationId])
  @@index([documentType])
  @@index([isActive])
  @@index([verificationStatus])
}

model VisaComplianceCheck {
  id                String                          @id @default(uuid())
  visaApplicationId String
  requirementType   String
  requirementStatus VisaComplianceRequirementStatus @default(PENDING)
  remarks           String?
  checkedByAdminId  String?
  checkedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visa  VisaApplication @relation(fields: [visaApplicationId], references: [id], onDelete: Cascade)
  admin User?           @relation(fields: [checkedByAdminId], references: [id], onDelete: SetNull)

  @@index([visaApplicationId])
  @@index([requirementStatus])
  @@index([checkedAt])
}

model VisaNotification {
  id                String               @id @default(uuid())
  visaApplicationId String
  adminUserId       String?
  notificationType  VisaNotificationType
  message           String
  isRead            Boolean              @default(false)
  createdAt         DateTime             @default(now())

  visa  VisaApplication @relation(fields: [visaApplicationId], references: [id], onDelete: Cascade)
  admin User?           @relation(fields: [adminUserId], references: [id], onDelete: SetNull)

  @@index([visaApplicationId])
  @@index([adminUserId])
  @@index([notificationType])
  @@index([createdAt])
}
