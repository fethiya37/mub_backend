generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String  @id @default(uuid())
  email             String? @unique
  phone             String  @unique
  passwordHash      String
  isActive          Boolean @default(true)
  applicantVerified Boolean @default(false)

  failedLoginCount Int       @default(0)
  lockUntil        DateTime?
  tokenVersion     Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles     UserRole[]
  refreshTokens RefreshToken[]
  actionTokens  AccountActionToken[]
  auditLogs     AuditLog[] @relation("AuditPerformedBy")

  applicantProfile     ApplicantProfile?
  employer             Employer?
  employerApprovalLogs EmployerApprovalLog[]
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String
  jti       String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum AccountActionTokenType {
  ACCOUNT_SETUP
  PASSWORD_RESET
  EMAIL_VERIFY
}

model AccountActionToken {
  id        String               @id @default(uuid())
  userId    String
  type      AccountActionTokenType
  tokenHash String               @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime             @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  performedBy String?
  action      String
  entityType  String?
  entityId    String?
  ipAddress   String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  performer User? @relation("AuditPerformedBy", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([performedBy])
  @@index([createdAt])
  @@index([action])
}

enum ApplicantProfileStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

enum ApplicantDocumentType {
  PASSPORT
  PERSONAL_PHOTO
  COC_CERTIFICATE
  LABOR_ID
  OTHER
}

model ApplicantProfile {
  applicantId String  @id @default(uuid())
  userId      String? @unique

  firstName      String?
  lastName       String?
  gender         String?
  dateOfBirth    DateTime?
  nationality    String?
  passportNumber String?
  passportExpiry DateTime?
  laborId        String?
  region         String?

  phone         String
  email         String?
  address       String?
  maritalStatus String?

  visaNumber        String?
  applicationNumber String?
  barcodeValue      String?

  profileStatus ApplicantProfileStatus @default(DRAFT)

  rejectionReason String?
  verifiedBy      String?
  verifiedAt      DateTime?
  submittedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  skills          ApplicantSkill[]
  qualifications  ApplicantQualification[]
  workExperiences ApplicantWorkExperience[]
  documents       ApplicantDocument[]
  draftTokens     ApplicantDraftToken[]

  @@unique([phone])
  @@index([email])
  @@index([passportNumber])
  @@index([profileStatus])
  @@index([laborId])
}

model ApplicantDocument {
  id                 String  @id @default(uuid())
  applicantId        String
  documentType       ApplicantDocumentType
  fileUrl            String
  verificationStatus String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([applicantId, documentType])
  @@index([applicantId])
  @@index([documentType])
}

model ApplicantDraftToken {
  id          String   @id @default(uuid())
  applicantId String
  tokenHash   String   @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime @default(now())

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
  @@index([expiresAt])
}

model ApplicantSkill {
  id                String  @id @default(uuid())
  applicantId       String
  skillName         String
  proficiencyLevel  String?
  yearsOfExperience Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([applicantId, skillName])
  @@index([applicantId])
}

model ApplicantQualification {
  id                String  @id @default(uuid())
  applicantId       String
  qualificationType String
  institution       String?
  country           String?
  yearCompleted     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

model ApplicantWorkExperience {
  id               String    @id @default(uuid())
  applicantId      String
  jobTitle         String
  employerName     String?
  country          String?
  startDate        DateTime?
  endDate          DateTime?
  responsibilities String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

enum EmployerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum EmployerCreatedBy {
  EMPLOYER
  ADMIN
}

enum EmployerApprovalAction {
  APPROVED
  REJECTED
}

enum JobStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum ContractType {
  FULL_TIME
  PART_TIME
  TEMPORARY
  CONTRACT
  OTHER
}

model Employer {
  id                 String  @id @default(uuid())
  organizationName   String
  country            String
  contactEmail       String
  contactPhone       String
  registrationNumber String  @unique
  address            String?

  ownerName      String
  ownerIdNumber  String
  licenseNumber  String  @unique
  licenseFileUrl String
  licenseExpiry  DateTime?

  status    EmployerStatus    @default(PENDING)
  createdBy EmployerCreatedBy
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  approvalLogs EmployerApprovalLog[]
  jobs         JobPosting[]

  @@unique([contactEmail])
  @@unique([contactPhone])
  @@index([status])
  @@index([country])
  @@index([licenseNumber])
  @@index([ownerIdNumber])
}


model EmployerApprovalLog {
  id         String                 @id @default(uuid())
  employerId String
  action     EmployerApprovalAction
  reason     String?
  actionBy   String
  actionDate DateTime               @default(now())

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)
  admin    User     @relation(fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([actionDate])
}

model JobPosting {
  id             String       @id @default(uuid())
  employerId     String
  jobTitle       String
  jobDescription String
  country        String
  city           String?
  salaryRange    String?
  contractType   ContractType
  status         JobStatus    @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([status])
  @@index([country])
}
