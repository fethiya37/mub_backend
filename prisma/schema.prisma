generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
}


model User {
  id                String  @id @default(uuid())
  email             String? @unique
  phone             String  @unique
  passwordHash      String
  isActive          Boolean @default(true)
  applicantVerified Boolean @default(false)

  fullName String?
  status   UserStatus @default(PENDING)

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  failedLoginCount Int       @default(0)
  lockUntil        DateTime?
  tokenVersion     Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userRoles     UserRole[]
  refreshTokens RefreshToken[]
  actionTokens  AccountActionToken[]
  auditLogs     AuditLog[]           @relation("AuditPerformedBy")

  applicantProfile        ApplicantProfile?
  employer                Employer?
  employerApprovalLogs    EmployerApprovalLog[]
  localAgency             LocalAgency?
  localAgencyApprovalLogs LocalAgencyApprovalLog[] @relation("LocalAgencyActionBy")
  visaCases               VisaCase[]
}



model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
  userRoles       UserRole[]
}

model Permission {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String
  jti       String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum AccountActionTokenType {
  ACCOUNT_SETUP
  PASSWORD_RESET
  EMAIL_VERIFY
}

model AccountActionToken {
  id        String                 @id @default(uuid())
  userId    String
  type      AccountActionTokenType
  tokenHash String                 @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime               @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([expiresAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  performedBy String?
  action      String
  entityType  String?
  entityId    String?
  ipAddress   String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  performer User? @relation("AuditPerformedBy", fields: [performedBy], references: [id], onDelete: SetNull)

  @@index([performedBy])
  @@index([createdAt])
  @@index([action])
}

enum LocalAgencyStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum LocalAgencyApprovalAction {
  APPROVED
  REJECTED
  SUSPENDED
  REACTIVATED
}

model LocalAgency {
  id            String            @id @default(uuid())
  name          String
  licenseNumber String            @unique
  contactPerson String?
  phone         String?
  email         String?
  status        LocalAgencyStatus @default(PENDING)

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  rejectionReason String?
  approvedBy      String?
  approvedAt      DateTime?
  suspendedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  approvalLogs LocalAgencyApprovalLog[]

  @@index([status])
  @@index([licenseNumber])
  @@index([phone])
  @@index([email])
}

model LocalAgencyApprovalLog {
  id         String                    @id @default(uuid())
  agencyId   String
  action     LocalAgencyApprovalAction
  reason     String?
  actionBy   String
  actionDate DateTime                  @default(now())

  agency LocalAgency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  admin  User        @relation("LocalAgencyActionBy", fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([actionDate])
}

model ApplicantDraftToken {
  id          String    @id @default(uuid())
  applicantId String
  tokenHash   String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
  @@index([expiresAt])
}

enum ApplicantProfileStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

enum ApplicantDocumentType {
  PASSPORT
  PERSONAL_PHOTO
  COC_CERTIFICATE
  APPLICANT_ID
  OTHER
}

enum ApplicantRegistrationSource {
  SELF
  AGENCY
  MUB_STAFF
}

model ApplicantProfile {
  applicantId String  @id @default(uuid())
  userId      String? @unique

  firstName        String?
  middleName       String?
  lastName         String?
  gender           String?
  dateOfBirth      DateTime?
  placeOfBirth     String?
  nationality      String?
  religion         String?
  maritalStatus    String?
  numberOfChildren Int?

  occupation String?

  phone   String  @unique
  email   String?
  address String?

  height Float?
  weight Float?

  laborId String? @unique

  applicationNumber String                 @unique
  profileStatus     ApplicantProfileStatus @default(DRAFT)

  passportNumber    String?
  passportPlace     String?
  passportIssueDate DateTime?
  passportExpiry    DateTime?

  registrationSource ApplicantRegistrationSource @default(SELF)
  createdBy          String?

  rejectionReason String?
  verifiedBy      String?
  verifiedAt      DateTime?
  submittedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  emergencyContacts    EmergencyContact[]
  documents            ApplicantDocument[]
  skills               ApplicantSkill[]
  qualifications       ApplicantQualification[]
  workExperiences      ApplicantWorkExperience[]
  jobApplications      JobApplication[]
  applicantDraftTokens ApplicantDraftToken[]
  applicantExpenses    ApplicantExpense[]
  visaCases            VisaCase[]

  @@index([passportNumber])
  @@index([laborId])
  @@index([profileStatus])
  @@index([registrationSource])
}

model EmergencyContact {
  id           String  @id @default(uuid())
  applicantId  String
  fullName     String
  phone        String
  relationship String
  address      String?
  idFileUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

model ApplicantDocument {
  id           String                @id @default(uuid())
  applicantId  String
  documentType ApplicantDocumentType
  fileUrl      String
  status       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([applicantId, documentType])
  @@index([documentType])
}

model Skill {
  id   String @id @default(uuid())
  name String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicants ApplicantSkill[]
}

model ApplicantSkill {
  id          String @id @default(uuid())
  applicantId String
  skillId     String

  hasSkill       Boolean @default(true)
  willingToLearn Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)
  skill     Skill            @relation(fields: [skillId], references: [id], onDelete: Restrict)

  @@unique([applicantId, skillId])
  @@index([applicantId])
  @@index([skillId])
}

model ApplicantQualification {
  id            String @id @default(uuid())
  applicantId   String
  qualification String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

model ApplicantWorkExperience {
  id          String  @id @default(uuid())
  applicantId String
  jobTitle    String
  country     String?
  yearsWorked Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@index([applicantId])
}

enum EmployerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum EmployerCreatedBy {
  EMPLOYER
  ADMIN
}

enum EmployerApprovalAction {
  APPROVED
  REJECTED
}

enum JobStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum ContractType {
  FULL_TIME
  PART_TIME
  TEMPORARY
  CONTRACT
  OTHER
}

model Employer {
  id                 String  @id @default(uuid())
  organizationName   String
  country            String
  contactEmail       String
  contactPhone       String
  registrationNumber String  @unique
  address            String?

  logoUrl String?

  ownerName      String
  ownerIdNumber  String?
  ownerIdFileUrl String?
  licenseNumber  String    @unique
  licenseFileUrl String
  licenseExpiry  DateTime?

  status    EmployerStatus    @default(PENDING)
  createdBy EmployerCreatedBy
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  approvalLogs EmployerApprovalLog[]
  jobs         JobPosting[]
  visaCases    VisaCase[]

  @@unique([contactEmail])
  @@unique([contactPhone])
  @@index([status])
  @@index([country])
  @@index([licenseNumber])
  @@index([ownerIdNumber])
}


model EmployerApprovalLog {
  id         String                 @id @default(uuid())
  employerId String
  action     EmployerApprovalAction
  reason     String?
  actionBy   String
  actionDate DateTime               @default(now())

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)
  admin    User     @relation(fields: [actionBy], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([actionDate])
}

model JobPosting {
  id             String       @id @default(uuid())
  employerId     String
  jobTitle       String
  jobDescription String
  country        String
  city           String?
  salaryRange    String?
  thumbnailUrl   String?
  contractType   ContractType
  vacancies      Int
  status         JobStatus    @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employer        Employer         @relation(fields: [employerId], references: [id], onDelete: Cascade)
  jobApplications JobApplication[]
  visaCases       VisaCase[]

  @@index([employerId])
  @@index([status])
  @@index([country])
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  SELECTED
  WITHDRAWN
}

model JobApplication {
  id           String            @id @default(uuid())
  jobPostingId String
  applicantId  String
  cvFileUrl    String
  status       ApplicationStatus @default(PENDING)

  jobPosting JobPosting       @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  applicant  ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)

  @@unique([jobPostingId, applicantId])
  @@index([applicantId])
  @@index([status])
  @@index([jobPostingId])
}

enum VisaCaseStatus {
  INITIATED
  MEDICAL
  INSURANCE
  FINGERPRINT
  EMBASSY
  LMIS
  VISA
  FLIGHT_BOOKED
  RETURNED
  DEPLOYED
  CLOSED
}

enum MedicalFitnessResult {
  FIT
  UNFIT
}

enum EmbassyProcessStatus {
  PENDING
  COMPLETED
}

enum LMISStatus {
  PENDING
  ISSUED
  REJECTED
}

enum VisaAttemptStatus {
  ISSUED
  REJECTED
}

model Sponsor {
  id               String  @id @default(uuid())
  fullName         String
  sponsorIdFileUrl String?
  phone            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCases VisaCase[]
}

model VisaCase {
  id                 String         @id @default(uuid())
  applicantId        String
  partnerId          String?
  jobId              String?
  destinationCountry String
  status             VisaCaseStatus @default(INITIATED)
  isActive           Boolean        @default(true)
  caseManagerUserId  String
  sponsorId          String?

  completedStatuses  VisaCaseStatus[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant   ApplicantProfile @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)
  partner     Employer?        @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  job         JobPosting?      @relation(fields: [jobId], references: [id], onDelete: SetNull)
  caseManager User             @relation(fields: [caseManagerUserId], references: [id], onDelete: Restrict)
  sponsor     Sponsor?         @relation(fields: [sponsorId], references: [id], onDelete: SetNull)

  medical        VisaMedical?
  insurance      VisaInsurance?
  fingerprint    VisaFingerprint?
  embassyProcess EmbassyProcess?
  lmisProcess    LMISProcess?

  visaAttempts   VisaAttempt[]
  flightBookings FlightBooking[]
  returns        VisaReturn[]

  @@unique([applicantId, jobId, isActive])
  @@unique([applicantId, partnerId, isActive])
  @@index([applicantId])
  @@index([partnerId])
  @@index([jobId])
  @@index([destinationCountry])
  @@index([status])
  @@index([caseManagerUserId])
  @@index([sponsorId])
  @@index([isActive])
}


model VisaMedical {
  id            String               @id @default(uuid())
  visaCaseId    String               @unique
  reportFileUrl String
  result        MedicalFitnessResult
  expiresAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([result])
  @@index([expiresAt])
}

model VisaInsurance {
  id         String @id @default(uuid())
  visaCaseId String @unique

  providerName  String?
  policyNumber  String?
  policyFileUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([policyNumber])
}

model VisaFingerprint {
  id         String @id @default(uuid())
  visaCaseId String @unique

  isDone Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([isDone])
}

model EmbassyProcess {
  id         String @id @default(uuid())
  visaCaseId String @unique

  status EmbassyProcessStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([status])
}

model LMISProcess {
  id         String @id @default(uuid())
  visaCaseId String @unique

  status LMISStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([status])
}

model VisaAttempt {
  id            String            @id @default(uuid())
  visaCaseId    String
  attemptNumber Int
  status        VisaAttemptStatus

  applicationNumber String?
  visaNumber        String?
  issuedAt          DateTime?
  expiresAt         DateTime?
  rejectionReason   String?

  barcodeValue    String?
  barcodeImageUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@unique([visaCaseId, attemptNumber])
  @@index([visaCaseId])
  @@index([status])
}

model FlightBooking {
  id         String @id @default(uuid())
  visaCaseId String

  pnr         String
  airline     String?
  departureAt DateTime?
  arrivalAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([visaCaseId])
  @@index([pnr])
}

model VisaReturn {
  id         String @id @default(uuid())
  visaCaseId String

  reason     String
  returnedAt DateTime @default(now())

  createdAt DateTime @default(now())

  visaCase VisaCase @relation(fields: [visaCaseId], references: [id], onDelete: Cascade)

  @@index([visaCaseId])
  @@index([returnedAt])
}

model CompanyExpenseType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expenses CompanyExpense[]

  @@index([name])
}

model CompanyExpense {
  id            String  @id @default(uuid())
  typeId        String?
  typeNameOther String?
  amount        Decimal @db.Decimal(18, 2)

  expenseDate DateTime
  referenceNo String?
  description String?
  createdBy   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type CompanyExpenseType? @relation(fields: [typeId], references: [id], onDelete: SetNull)

  @@index([typeId])
  @@index([expenseDate])
  @@index([createdBy])
}

model ApplicantExpenseType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expenses ApplicantExpense[]

  @@index([name])
}

model ApplicantExpense {
  id            String  @id @default(uuid())
  applicantId   String
  typeId        String?
  typeNameOther String?
  amount        Decimal @db.Decimal(18, 2)

  expenseDate DateTime
  referenceNo String?
  description String?
  createdBy   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applicant ApplicantProfile      @relation(fields: [applicantId], references: [applicantId], onDelete: Cascade)
  type      ApplicantExpenseType? @relation(fields: [typeId], references: [id], onDelete: SetNull)

  @@index([applicantId])
  @@index([typeId])
  @@index([expenseDate])
  @@index([createdBy])
}


